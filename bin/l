#!/usr/bin/env ruby

require 'etc'

# TODO: show file mode
# TODO: show slink

class Node
  attr_reader :name, :stat
  def initialize(entry)
    @name = entry
    @stat = File.lstat(entry)
  end

  def uid
    Etc.getpwuid(@stat.uid).name
  end

  def gid
    Etc.getgrgid(@stat.gid).name
  end

  def dir?
    @stat.directory?
  end

  def file?
    @stat.file?
  end

  def exec?
    @stat.executable_real?
  end

  def sym?
    @stat.symlink?
  end

  def mode
    mode = @stat.mode

    str = ""

    # user
    str << ((mode & Integer("0b100000000") > 0) ? "r" : "-")
    str << ((mode & Integer("0b010000000") > 0) ? "w" : "-")
    str << ((mode & Integer("0b001000000") > 0) ? "x" : "-")

    # group
    str << ((mode & Integer("0b000100000") > 0) ? "r" : "-")
    str << ((mode & Integer("0b000010000") > 0) ? "w" : "-")
    str << ((mode & Integer("0b000001000") > 0) ? "x" : "-")

    # other
    str << ((mode & Integer("0b000000100") > 0) ? "r" : "-")
    str << ((mode & Integer("0b000000010") > 0) ? "w" : "-")
    str << ((mode & Integer("0b000000001") > 0) ? "x" : "-")

    str
  end

  def size
    size = @stat.size
    if size > 1024*1024
      size = size.quo(1024*1024).round(1).to_f.to_s + "M"
    elsif size > 1024
      size = size.quo(1024).round(1).to_f.to_s + "K"
    else
      size = size.to_s + "B"
    end
    size.rjust(6)
  end

  def mtime
    @stat.mtime.strftime("%Y-%m-%d %H:%M")
  end

  def to_s
    name = @name
    if dir?
      name = "[0;34m#{name}[0m"
    elsif sym?
      path = File.readlink(name)
      name =  "[0;36m#{name}[0m -> #{path}"
    elsif exec?
      name =  "[0;31m#{name}[0m"
    end

    if ARGV[0] != "-a"
      return name.to_s
    end

    [
      mode,
      uid,
      gid,
      size,
      mtime,
      name
    ].join(" ")
  end

  def <=>(target)
    if dir? && target.dir?
      return @name <=> target.name
    end
    if file? && target.file?
      return @name <=> target.name
    end
    dir? ? -1: 1
  end
end

result = Dir.entries(".").reject {|entry|
  entry == "." || entry == ".."
}.map {|entry|
  Node.new(entry)
}.sort

puts result
