#!/usr/bin/env ruby

HELP=<<EOS
simplest http server shows current directory
- default port: 3000
- export text formats as text/plain (md, log, json etc)
- returns default favicon: $DOTFILES/misc/favicon.ico

$ http
$ http 4000
EOS

require "webrick"

port = ARGV.shift || 3000

# http://svn.ruby-lang.org/cgi-bin/viewvc.cgi/trunk/lib/webrick/httputils.rb?view=markup
mime = WEBrick::HTTPUtils::DefaultMimeTypes.merge({
  "js"       => "text/javascript",
  "json"     => "text/json",
  "log"      => "text/plain",
  "md"       => "text/plain",
  "markdown" => "text/plain",
})

config = {
  :Port            => port,
  :DocumentRoot    => ".",
  :MimeTypes       => mime,
  :StartCallback   => lambda {
    puts `ip`
  },
  :RequestCallback => lambda {|req, res|
    res.header.merge!({
      "Cache-Fingerprint-Key" => rand(100) + 1
    })
  }
}

server = WEBrick::HTTPServer.new(config)
server.mount("/favicon.ico", WEBrick::HTTPServlet::FileHandler, "#{__dir__}/../misc/favicon.ico")

i = 0
server.mount_proc('/random') do |req, res|
  sleep(2)
  seq = (i+=1).to_s
  now = Time.now.to_s
  random = (0...8).map{ ('A'..'Z').to_a[rand(26)] }.join

  res.body = [seq, now, random].join("\n")
end

Signal.trap("INT") { server.shutdown }
server.start
