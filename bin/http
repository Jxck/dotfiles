#!/usr/bin/env ruby

HELP=<<EOS
simplest http server shows current directory
- default port: 3000
- export text formats as text/plain (md, log, json etc)
- returns default favicon: $DOTFILES/misc/favicon.ico

$ http
$ http 4000
EOS

require "webrick"
require "json"

if ARGV.include?('-h')
  puts HELP
  exit(0)
end

port = ARGV.shift || 3000

# http://svn.ruby-lang.org/cgi-bin/viewvc.cgi/trunk/lib/webrick/httputils.rb?view=markup
mime = WEBrick::HTTPUtils::DefaultMimeTypes.merge({
  "js"       => "text/javascript",
  "json"     => "text/json",
  "log"      => "text/plain",
  "md"       => "text/plain",
  "markdown" => "text/plain",
  "webp"     => "image/webp",
})

config = {
  :Port            => port,
  :DocumentRoot    => ".",
  :MimeTypes       => mime,
  :StartCallback   => lambda {
    puts `ip`
  },
  :RequestCallback => lambda {|req, res|
    res.header.merge!({
      #"Cache-Control" => "max-age=10, stale-if-error=30"
      "Cache-Control" => "max-age=0, stale-while-revalidate=1000"
    })
  }
}

server = WEBrick::HTTPServer.new(config)

# /favicon.ico
server.mount("/favicon.ico", WEBrick::HTTPServlet::FileHandler, "#{__dir__}/../misc/favicon.ico")


# random handler
random = Proc.new do |req, res|
  #sleep(2)
  @i ||= 0
  seq = (@i+=1).to_s
  now = Time.now.to_s
  random = (0...8).map{ ('A'..'Z').to_a[rand(26)] }.join

  ext = File.extname(req.path)
  ext = ".html" if ext == ""
  res.header.merge!({
    "Content-Type" => "text/#{ext}",
    "X-Seq" => seq
  })

  body = ""
  case ext
  when ".json"
    body = JSON.pretty_generate({
      seq: seq,
      now: now,
      random: random
    })
  when ".html"
    body =<<-EOS
<!DOCTYPE html>
<meta charset=utf-8>
<title>random</title>
<h1>Test</h1>
<a href=/random>/random</a>
<dl>
  <dt>seq</dt><dd>#{seq}</dd>
  <dt>now</dt><dd>#{now}</dd>
  <dt>random</dt><dd>#{random}</dd>
</dl>
    EOS
  end
  res.body = body
end

# /random.(html|json)
server.mount_proc('/random', random)
server.mount_proc('/random.html', random)
server.mount_proc('/random.json', random)

# /upload
class Uploader < WEBrick::HTTPServlet::AbstractServlet
  def do_POST(req, res)
    filename = req.query['upload'].filename
    uploadedFile = File.open(filename, "wb")
    uploadedFile.write req.query['upload'].to_s
    uploadedFile.close
    res.set_redirect(WEBrick::HTTPStatus::SeeOther, '/')
  end

  def do_GET(req, res)
    res.content_type = "text/html"
    res.body = <<-EOS
      <form method=POST action=/upload enctype=multipart/form-data>
          <input type=file name=upload />
          <input type=submit value=upload />
      </form>
    EOS
  end
end
server.mount('/upload', Uploader)

Signal.trap("INT") { server.shutdown }
server.start
