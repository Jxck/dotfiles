#!/usr/bin/env ruby

require "webrick"
require "webrick/https"

port = ARGV.shift || 3000
key  = ARGV.shift || "#{__dir__}/../keys/key.pem"
cert = ARGV.shift || "#{__dir__}/../keys/cert.pem"

# http://svn.ruby-lang.org/cgi-bin/viewvc.cgi/trunk/lib/webrick/httputils.rb?view=markup
mime = WEBrick::HTTPUtils::DefaultMimeTypes.merge({
  :js       => "text/javascript",
  :json     => "text/json",
  :log      => "text/plain",
  :md       => "text/plain",
  :markdown => "text/plain",
})

config = {
  :Port            => port,
  :DocumentRoot    => ".",
  :MimeTypes       => mime,
  :SSLEnable       => true,
  :SSLCertificate  => OpenSSL::X509::Certificate.new(File.open(cert).read),
  :SSLPrivateKey   => OpenSSL::PKey::RSA.new(File.open(key).read),
  :StartCallback   => lambda {
    puts `ip`
  },
  :RequestCallback => lambda {|req, res|
    if req.path == "/favicon.ico"
      res.filename = "#{__dir__}/../misc/favicon.ico"
      return
    end

    puts req
    res.header.merge!({
      "Cache-Fingerprint-Key" => rand(100) + 1
    })
  }

  # auto generate self signed cert file
  # :SSLCertName => [["CN", "devserver"]],
}

server = WEBrick::HTTPServer.new(config)
Signal.trap("INT") { server.shutdown }
server.start
