#!/usr/bin/env ruby

arg = ARGV[0]
PATH="~/.gobrew/go"
URL="https://go.googlecode.com/files"
ARCH = `uname` == "Darwin" ? "darwin-amd64-osx10.6" : "linux-amd64"

if arg == nil
  puts `gobrew version && gobrew path`
end

if arg == "here"
  current = Dir::pwd

template = <<EOS
export GOPATH=#{current}
export PATH=$PATH:$GOROOT/bin:$GOPATH/bin
EOS
  path = File::expand_path('~') + "/.gobrew/env/.gopath"
  env = File.open(path,'w')
  env.puts template
  env.close
end

if arg == "path"
  puts `echo $GOPATH`
end

if arg == "list"
  puts `\ls #{PATH} | grep go | sed "s/go//"`
end

if arg == "use"
  version = ARGV[1]
  puts "use go"+version
  `rm #{PATH}/current`
  `ln -s #{PATH}/go#{version} #{PATH}/current`
end

if arg == "install"
  version = "go#{ARGV[1]}"
  file = "#{version}.#{ARCH}.tar.gz"
  url = "#{URL}/#{file}"
  puts "downloading #{url}"
  if `which curl`
    `curl #{url} -o /tmp/#{file}`
  else
    `wget #{url} -P /tmp`
  end
  `tar zxvf /tmp/#{file} -C /tmp`
  `mv /tmp/go #{PATH}/#{version}`
end

if arg == "version"
  info = `file #{PATH}/current`
  puts info.split('/').last.sub("'", "")
end

if arg == "-h"
  puts <<-EOS
$ gobrew install 1.2
$ gobrew use 1.2
$ gobrew version
$ gobrew list
$ gobrew here
$ gobrew path
$ gobrew -h
  EOS
end
